# Token Skip & Mid-Layer Early-Exit å®ç°è¯´æ˜

## 1. ä¿®æ”¹èŒƒå›´

åªä¿®æ”¹ `llada/` ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œ**ä¸åŠ¨ `v2/`**ã€‚

**å‚è€ƒèµ„æ–™**ï¼š`ES-dLLM/` ç›®å½•ä¸‹çš„ä»£ç ä»…ä¾›å‚è€ƒï¼Œä¸ç›´æ¥ä½¿ç”¨ã€‚

---

## 2. æ ¸å¿ƒç›®æ ‡

**Token-level (across denoising steps)**:
> Compute the cosine similarity of token hidden states across adjacent denoising steps. If the cosine similarity is sufficiently high, skip computing those tokens at the current step by reusing the previous step's outputs.

**ç›´è§‚ç†è§£**ï¼šåœ¨æ‰©æ•£ LLM çš„å»å™ªè¿‡ç¨‹ä¸­ï¼Œç›¸é‚» step ä¹‹é—´ï¼ŒæŸäº› token çš„ hidden state å¯èƒ½éå¸¸ç›¸ä¼¼ï¼ˆç‰¹åˆ«æ˜¯å·²ç» unmask çš„ tokenï¼‰ã€‚å¦‚æœç›¸ä¼¼åº¦è¶³å¤Ÿé«˜ï¼Œå°±ä¸éœ€è¦é‡æ–°è®¡ç®—è¿™äº› tokenï¼Œç›´æ¥å¤ç”¨ä¸Šä¸€æ­¥çš„è¾“å‡ºå³å¯ã€‚

---

## 3. æ–¹æ¡ˆ Aï¼šBlock å†… Unmask Token å†»ç»“ï¼ˆæ¨èå…ˆå®ç°ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šåœ¨å½“å‰ block å†…ï¼Œå·²ç» unmask çš„ token å†…å®¹å·²ç¡®å®šï¼Œå®ƒä»¬çš„ KV å˜åŒ–å¯èƒ½å¾ˆå°ï¼Œå¯ä»¥å†»ç»“å¤ç”¨ã€‚

```
å½“å‰ DualCache:
  Block 0 (å·²å®Œæˆ) | Block 1 (å½“å‰ block)
  [å·²å†»ç»“ KV]      | [æ‰€æœ‰ token æ¯ step é‡æ–°è®¡ç®— KV]

æ–°æ–¹æ¡ˆ:
  Block 0 (å·²å®Œæˆ) | Block 1 (å½“å‰ block)
  [å·²å†»ç»“ KV]      | [å·² unmask â†’ å†»ç»“ KV] [masked â†’ æ­£å¸¸è®¡ç®—]
```

**ä¼˜åŠ¿**ï¼š
- **å®ç°ç®€å•**ï¼šä¸éœ€è¦è®¡ç®— cosine similarityï¼Œç›´æ¥ç”¨ mask çŠ¶æ€åˆ¤æ–­
- **ä¸ DualCache å…¼å®¹æ€§å¥½**ï¼šåªæ˜¯å¢åŠ "éƒ¨åˆ†å†»ç»“"é€»è¾‘
- **æ¸è¿›åŠ é€Ÿ**ï¼šéšç€ unmask å¢å¤šï¼Œå†»ç»“çš„ token è¶Šå¤šï¼ŒåŠ é€Ÿæ•ˆæœé€’å¢

**å…³é”®å†³ç­–**ï¼š
- **æ¯éš” N ä¸ª step å¼ºåˆ¶å®Œæ•´æ›´æ–°**ï¼šé¿å…è¯¯å·®ç´¯ç§¯ï¼ˆé»˜è®¤ N=3ï¼‰
- å†»ç»“ = å¤ç”¨ä¸Šä¸€æ­¥çš„ hidden state å’Œ KVï¼Œä¸é‡æ–°è®¡ç®—
- åªæœ‰ masked token åœ¨æ¯ä¸ª step é‡æ–°è®¡ç®—

**å‚æ•°**ï¼š
- `force_full_interval`ï¼šæ¯éš”å¤šå°‘ step å¼ºåˆ¶å®Œæ•´è®¡ç®—ï¼ˆé»˜è®¤ 3ï¼‰

---

## 4. æ–¹æ¡ˆ Bï¼šMid-Layer Early-Exitï¼ˆè¿›é˜¶æ–¹æ¡ˆï¼‰

**ç›®æ ‡**ï¼šå¦‚æœæŸ token åœ¨ç¬¬ k å±‚çš„ hidden state ä¸ä¸Šä¸€æ­¥ç›¸ä¼¼ï¼Œè·³è¿‡ k+1 åˆ° 31 å±‚ã€‚

**å…³é”®å†³ç­–**ï¼š
- **Token çº§åˆ«**çš„ early-exitï¼ˆä¸æ˜¯ block çº§åˆ«ï¼‰
- **è·¨æ­¥æ¯”è¾ƒ**ï¼ˆå½“å‰ step vs ä¸Šä¸€ stepï¼‰
- è·³è¿‡çš„ token ä½¿ç”¨**ä¸Šä¸€æ­¥çš„ hidden state å’Œ KV cache**
- è·³è¿‡ = å¤ç”¨ä¸­é—´çŠ¶æ€ï¼ˆhidden state / KVï¼‰ï¼Œå¹¶ä¸”ä¸é‡æ–°è®¡ç®—è¯¥ token åœ¨è¯¥ layer çš„ forward
- éœ€è¦ç»´æŠ¤ `prev_step_hidden_states` å’Œ `prev_step_kv_cache` ä¿è¯ä¸€è‡´æ€§
- **æ¯éš” X ä¸ª step å¼ºåˆ¶å›å½’ dualcache æ¨¡å¼**ï¼šå¼ºåˆ¶ä¸è·³è¿‡ä»»ä½• tokenï¼Œé¿å…è¯¯å·®ç´¯ç§¯

**å‚æ•°**ï¼š
- `early_exit_layer`ï¼šåœ¨å“ªå±‚åšåˆ¤æ–­ï¼ˆå¦‚ 16, 20, 24ï¼‰
- `early_exit_threshold`ï¼šcosine similarity é˜ˆå€¼ï¼ˆå¦‚ 0.9ï¼‰
- `force_full_interval`ï¼šæ¯éš”å¤šå°‘ step å¼ºåˆ¶å®Œæ•´è®¡ç®—ï¼ˆå¦‚ 4ï¼‰

---

## 5. æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | åˆ¤æ–­ä¾æ® | è·³è¿‡ä»€ä¹ˆ | å®ç°å¤æ‚åº¦ | æ¨èé¡ºåº |
|------|---------|---------|-----------|---------|
| **A: Unmask å†»ç»“** | mask çŠ¶æ€ | æ•´ä¸ª forwardï¼ˆå¯¹ unmask tokenï¼‰ | ä¸­ | **å…ˆå®ç°** |
| **B: Mid-Layer Exit** | cosine similarity | åç»­å±‚ï¼ˆå¯¹é«˜ç›¸ä¼¼åº¦ tokenï¼‰ | é«˜ | åå®ç° |
| **A + B ç»“åˆ** | mask + similarity | çµæ´»ç»„åˆ | æœ€é«˜ | æœ€åè€ƒè™‘ |

---

## 6. Risks åˆ†æ

### 6.1 ğŸŸ¡ åŒå‘ Attention ä¸‹çš„ Hidden State æ¼‚ç§»ï¼ˆæ–¹æ¡ˆ A ç‰¹æœ‰ï¼‰

åœ¨ LLaDA ä¸­ï¼Œattention æ˜¯**åŒå‘çš„**ï¼ˆé causalï¼‰ï¼š
```
å·² unmask token A çš„ hidden state = f(A attend to æ‰€æœ‰ token)
                                  = f(A attend to [å…¶ä»– unmask] + [masked tokens])
```

**é—®é¢˜**ï¼šå³ä½¿ A çš„å†…å®¹å·²ç¡®å®šï¼Œå®ƒçš„ hidden state ä»ç„¶ä¼šå— masked token çš„å½±å“ã€‚å¦‚æœ masked token åœ¨å½“å‰ step å˜åŒ–äº†ï¼ŒA çš„ hidden state ç†è®ºä¸Šä¹Ÿä¼šå˜åŒ–ã€‚

**ç¼“è§£æªæ–½**ï¼š
- æ¯éš” N æ­¥å¼ºåˆ¶å®Œæ•´è®¡ç®—ï¼ŒåŒæ­¥æ‰€æœ‰ token çš„çŠ¶æ€
- å®éªŒè¡¨æ˜å»å™ªåæœŸå˜åŒ–è¾ƒå°ï¼Œå¯æ¥å—

---

### 6.2 ğŸ”´ KV Cache ä¸€è‡´æ€§é—®é¢˜ï¼ˆé«˜é£é™©ï¼Œä¸¤ä¸ªæ–¹æ¡ˆå…±æœ‰ï¼‰

**åœºæ™¯**ï¼šå‡è®¾ token A è¢«åˆ¤å®šä¸º"å¯è·³è¿‡"ï¼Œtoken B æ­£å¸¸è®¡ç®—ã€‚

```
Step T-1: Token A å’Œ B éƒ½æ­£å¸¸è®¡ç®—ï¼ŒKV_A(T-1) å’Œ KV_B(T-1) è¢«å­˜å‚¨
Step T:   Token A è·³è¿‡åç»­å±‚ï¼ŒToken B æ­£å¸¸è®¡ç®—
          â†’ é—®é¢˜ï¼šToken B åœ¨åš attention æ—¶éœ€è¦çœ‹ Token A çš„ KV
          â†’ å¦‚æœ A ç”¨çš„æ˜¯æ—§çš„ KVï¼ŒB çš„ attention score æ˜¯å¦æ­£ç¡®ï¼Ÿ
```

**å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ**ï¼š
- **æ–¹æ¡ˆ A**ï¼šè·³è¿‡çš„ token ä»ç„¶æ›´æ–° KVï¼ˆç”¨æ—§ hidden state è®¡ç®— Q/K/V æŠ•å½±ï¼‰ï¼Œä½†è·³è¿‡ attention å’Œ FFN
- **æ–¹æ¡ˆ B**ï¼šç›´æ¥å¤ç”¨æ—§ KVï¼Œæ¥å—å¯èƒ½çš„ç²¾åº¦æŸå¤±
- **æ–¹æ¡ˆ C**ï¼šå¯¹æ¯å±‚åˆ†åˆ«åˆ¤æ–­ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§è·³è¿‡æ‰€æœ‰åç»­å±‚

**å½“å‰å†³ç­–**ï¼šå¾…å®éªŒç¡®å®šã€‚å…ˆç”¨æ–¹æ¡ˆ B å®ç° baselineï¼Œå†æ ¹æ®ç²¾åº¦æŸå¤±æƒ…å†µå†³å®šæ˜¯å¦éœ€è¦æ–¹æ¡ˆ A/Cã€‚

### 6.3 ğŸŸ¡ Masked vs Unmasked Token å·®å¼‚ï¼ˆæ–¹æ¡ˆ B ç‰¹æœ‰ï¼‰

- **å·² unmask çš„ token**ï¼šå†…å®¹å·²ç¡®å®šï¼Œè·¨ step çš„ hidden state ç›¸å¯¹ç¨³å®šï¼Œé€‚åˆ skip
- **ä» masked çš„ token**ï¼šæ¨¡å‹è¿˜åœ¨"çŒœæµ‹"ï¼Œhidden state å¯èƒ½å‰§çƒˆå˜åŒ–ï¼Œä¸å®œ skip

**å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ**ï¼š
- åªå¯¹å·² unmask çš„ token åš skip åˆ¤æ–­
- æˆ–è€…ï¼šå¯¹ masked token ä½¿ç”¨æ›´é«˜çš„é˜ˆå€¼

**å½“å‰å†³ç­–**ï¼šå¾…å®éªŒç¡®å®šã€‚å…ˆç»Ÿä¸€é˜ˆå€¼ï¼Œå†æ ¹æ®åˆ†æç»“æœå†³å®šæ˜¯å¦åŒºåˆ†ã€‚

### 6.4 ğŸŸ¡ åˆ¤æ–­å±‚é€‰æ‹©ï¼ˆæ–¹æ¡ˆ B ç‰¹æœ‰ï¼‰

- **å¤ªæµ…ï¼ˆå¦‚ layer 8ï¼‰**ï¼šå‰é¢å±‚ä¿¡æ¯ä¸è¶³ï¼Œå¯èƒ½è¯¯åˆ¤
- **å¤ªæ·±ï¼ˆå¦‚ layer 28ï¼‰**ï¼šèƒ½è·³è¿‡çš„å±‚å¤ªå°‘ï¼Œæ”¶ç›Šæœ‰é™
- **æ¨èèŒƒå›´**ï¼šlayer 16-24ï¼ˆä¸­é—´å±‚ï¼‰

**å½“å‰å†³ç­–**ï¼šé»˜è®¤ `early_exit_layer=20`ï¼Œå¾…å®éªŒè°ƒä¼˜ã€‚

### 6.5 ğŸŸ¡ é˜ˆå€¼æ•æ„Ÿæ€§ï¼ˆæ–¹æ¡ˆ B ç‰¹æœ‰ï¼‰

- é˜ˆå€¼å¤ªé«˜ï¼ˆ0.99ï¼‰â†’ å‡ ä¹ä¸è·³è¿‡ â†’ æ— åŠ é€Ÿ
- é˜ˆå€¼å¤ªä½ï¼ˆ0.8ï¼‰â†’ å¤§é‡è·³è¿‡ â†’ ç²¾åº¦å´©æºƒ

**å½“å‰å†³ç­–**ï¼šé»˜è®¤ `early_exit_threshold=0.95`ï¼Œå¾…å®éªŒè°ƒä¼˜ã€‚

### 6.6 ğŸŸ¢ é¢å¤–æ˜¾å­˜å¼€é”€ï¼ˆä½é£é™©ï¼Œä¸¤ä¸ªæ–¹æ¡ˆå…±æœ‰ï¼‰

éœ€è¦å­˜å‚¨ï¼š
- `prev_hidden_states[layer_k]`: [B, L, D] â‰ˆ 16MB (bf16, B=1, L=1024, D=4096)
- `prev_kv_cache[layer_k:]`: æ¯å±‚ 2 Ã— [B, H, L, D_head]

å¯¹äºå•å±‚åˆ¤æ–­ï¼Œå¼€é”€å¯æ§ã€‚

### 6.7 ğŸŸ¡ åŠ¨æ€ batch çš„ GPU æ•ˆç‡ï¼ˆä¸­é£é™©ï¼Œä¸¤ä¸ªæ–¹æ¡ˆå…±æœ‰ï¼‰

éƒ¨åˆ† token è·³è¿‡ â†’ éœ€è¦ gather/scatter â†’ å¯èƒ½å½±å“å¹¶è¡Œæ•ˆç‡ã€‚

**å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ `torch.where` ä»£æ›¿åŠ¨æ€ç´¢å¼•
- æˆ–è€…ï¼šåªåœ¨ skip æ¯”ä¾‹è¶…è¿‡æŸé˜ˆå€¼æ—¶æ‰çœŸæ­£è·³è¿‡è®¡ç®—

**å½“å‰å†³ç­–**ï¼šå…ˆç”¨ç®€å•å®ç°ï¼Œå†æ ¹æ® profiling ç»“æœä¼˜åŒ–ã€‚

---

## 7. å®ç°è®¡åˆ’

### Phase 1ï¼šæ–¹æ¡ˆ Aï¼ˆBlock å†… Unmask å†»ç»“ï¼‰

| æ­¥éª¤ | ä»»åŠ¡ | äº§ç‰© |
|------|------|------|
| 1.1 | ç†è§£ `generate_with_dual_cache()` çš„é€»è¾‘ | æ³¨é‡Š/æµç¨‹å›¾ |
| 1.2 | åˆ›å»º `generate_with_unmask_freeze()` å‡½æ•° | `llada/generate.py` |
| 1.3 | æ·»åŠ  `force_full_interval` å‚æ•°æ”¯æŒ | åŒä¸Š |
| 1.4 | å†™æµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ | `llada/test_unmask_freeze.py` |
| 1.5 | åœ¨ GSM8K ä¸Š benchmark | è¯„æµ‹ç»“æœ |

### Phase 2ï¼šæ–¹æ¡ˆ Bï¼ˆMid-Layer Early-Exitï¼‰

| æ­¥éª¤ | ä»»åŠ¡ | äº§ç‰© |
|------|------|------|
| 2.1 | åˆ›å»º `MidTokenSkipCache` ç±» | `llada/mid_token_skip.py` |
| 2.2 | ä¿®æ”¹ `LLaDAModel.forward()` æ·»åŠ  early-exit é€»è¾‘ | ä¿®æ”¹ `llada/model/modeling_llada.py` |
| 2.3 | åˆ›å»º `generate_with_mid_token_skip()` å‡½æ•° | `llada/generate.py` |
| 2.4 | æµ‹è¯• + benchmark | è¯„æµ‹ç»“æœ |

---

## 8. å¾…è®¨è®ºé—®é¢˜

1. **æ–¹æ¡ˆ A çš„ `force_full_interval` æœ€ä½³å€¼**ï¼Ÿé»˜è®¤ 3 æ˜¯å¦åˆé€‚ï¼Ÿéœ€è¦å®éªŒç¡®å®šã€‚

2. **æ–¹æ¡ˆ A å’Œ B æ˜¯å¦å¯ä»¥ç»“åˆ**ï¼Ÿä¾‹å¦‚ï¼šå¯¹ unmask token ç”¨æ–¹æ¡ˆ Aï¼ˆç›´æ¥å†»ç»“ï¼‰ï¼Œå¯¹ masked token ç”¨æ–¹æ¡ˆ Bï¼ˆç›¸ä¼¼åº¦åˆ¤æ–­ï¼‰ã€‚

3. **ä¸ parallel decoding çš„äº¤äº’**ï¼Ÿå½“å‰ FastLLM æ”¯æŒ confidence-aware parallel decodingï¼Œunmask å†»ç»“æ˜¯å¦ä¼šå½±å“è¿™ä¸ªæœºåˆ¶ï¼Ÿ

4. **åˆ¤æ–­å±‚ä¹‹å‰çš„å±‚æ˜¯å¦ä¹Ÿéœ€è¦ skipï¼ˆæ–¹æ¡ˆ Bï¼‰**ï¼Ÿå½“å‰æ–¹æ¡ˆåªè·³è¿‡åˆ¤æ–­å±‚ä¹‹åçš„å±‚ï¼Œåˆ¤æ–­å±‚ä¹‹å‰ä»ç„¶å®Œæ•´è®¡ç®—ã€‚

5. **æ˜¯å¦éœ€è¦ per-layer é˜ˆå€¼ï¼ˆæ–¹æ¡ˆ Bï¼‰**ï¼Ÿä¸åŒå±‚çš„ hidden state å˜åŒ–å¹…åº¦å¯èƒ½ä¸åŒã€‚
